<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redwood Adoption Estimator</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- SheetJS for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body>

<div id="app" class="min-h-screen p-8">
    <div class="max-w-7xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden">
        
        <!-- Header -->
        <div class="bg-blue-900 text-white p-6 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold">Redwood Adoption Estimator</h1>
                <p class="text-blue-200 text-sm">Web-based Calculation Tool</p>
            </div>
            <button @click="generateExcel" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded flex items-center gap-2 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                Download Excel
            </button>
        </div>

        <div class="p-8">
            <!-- Configuration Section -->
            <div class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Customer Name</label>
                    <input v-model="customerName" type="text" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="e.g. Global Enterprises">
                </div>
                <div class="flex items-end">
                    <button @click="addProduct" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full transition">
                        + Add New Product
                    </button>
                </div>
            </div>

            <!-- Products List -->
            <div v-for="(product, pIndex) in products" :key="pIndex" class="mb-8 border rounded-lg p-6 bg-gray-50 relative group">
                
                <!-- Product Header -->
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <div class="flex items-center gap-3">
                        <select v-model="product.name" class="text-lg font-bold bg-transparent border-none focus:ring-0 p-0 text-gray-800">
                            <option v-for="pName in availableProductNames" :value="pName">{{ pName }}</option>
                        </select>
                        <span class="bg-gray-200 text-gray-700 text-xs px-2 py-1 rounded">Weight: {{ getProductWeight(product.name) }}x</span>
                    </div>
                    <button @click="removeProduct(pIndex)" class="text-red-500 hover:text-red-700 text-sm font-semibold">Remove Product</button>
                </div>

                <!-- Modules Table -->
                <table class="w-full text-sm text-left text-gray-500 mb-4">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-200">
                        <tr>
                            <th scope="col" class="px-4 py-3">Module Name</th>
                            <th scope="col" class="px-4 py-3 w-32">Features</th>
                            <th scope="col" class="px-4 py-3 w-32">Personalizations</th>
                            <th scope="col" class="px-4 py-3 w-10"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(module, mIndex) in product.modules" :key="mIndex" class="bg-white border-b hover:bg-gray-50">
                            <td class="px-4 py-2">
                                <input v-model="module.name" type="text" class="w-full bg-transparent border-none focus:ring-0" placeholder="e.g. Purchasing">
                            </td>
                            <td class="px-4 py-2">
                                <input v-model.number="module.features" type="number" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded focus:ring-blue-500 focus:border-blue-500 block p-1" min="0">
                            </td>
                            <td class="px-4 py-2">
                                <input v-model.number="module.personalizations" type="number" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded focus:ring-blue-500 focus:border-blue-500 block p-1" min="0">
                            </td>
                            <td class="px-4 py-2 text-center">
                                <button @click="removeModule(pIndex, mIndex)" class="text-red-400 hover:text-red-600">Ã—</button>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <button @click="addModule(pIndex)" class="text-blue-600 hover:text-blue-800 text-sm font-semibold flex items-center gap-1">
                    + Add Module
                </button>

                <!-- Product Summary -->
                <div class="mt-4 bg-white p-3 rounded border border-gray-200 flex justify-between items-center text-sm">
                    <div class="text-gray-600">
                        <span class="font-bold">{{ product.modules.reduce((sum, m) => sum + m.features, 0) }}</span> Features &nbsp;|&nbsp;
                        <span class="font-bold">{{ product.modules.reduce((sum, m) => sum + m.personalizations, 0) }}</span> Personalizations
                    </div>
                    <div class="text-gray-400 text-xs">Complexity Weight applied in calculation</div>
                </div>
            </div>

            <!-- Grand Total Summary -->
            <div class="bg-gray-800 text-white p-6 rounded-lg mt-8">
                <h3 class="text-xl font-bold mb-4">Estimation Summary</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <div class="text-gray-400 text-xs uppercase">Total Features</div>
                        <div class="text-2xl font-bold">{{ grandTotals.features }}</div>
                    </div>
                    <div>
                        <div class="text-gray-400 text-xs uppercase">Total Personalizations</div>
                        <div class="text-2xl font-bold">{{ grandTotals.personalizations }}</div>
                    </div>
                    <div>
                        <div class="text-gray-400 text-xs uppercase">Est. CSU (Hours)</div>
                        <div class="text-2xl font-bold text-green-400">{{ grandTotals.csu }}</div>
                    </div>
                    <div>
                        <div class="text-gray-400 text-xs uppercase">Products</div>
                        <div class="text-2xl font-bold">{{ products.length }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                customerName: "Global Enterprises",
                availableProductNames: [
                    "SCM Common Components", "Inventory Management", "Maintenance", "Manufacturing",
                    "Order Management", "Collaboration Messaging Framework", "Procurement",
                    "Product Hub", "Purchasing", "Quality Management", "Self Service Procurement & RSSP",
                    "Supply Chain Collaboration", "Supply Chain Orchestration", "Supply Chain Planning"
                ],
                productWeights: {
                    "SCM Common Components": 0.5, "Inventory Management": 1.2, "Maintenance": 1.2,
                    "Manufacturing": 1.5, "Order Management": 1.0, "Collaboration Messaging Framework": 1.0,
                    "Procurement": 1.0, "Product Hub": 1.0, "Purchasing": 1.0, "Quality Management": 1.1,
                    "Self Service Procurement & RSSP": 1.0, "Supply Chain Collaboration": 1.0,
                    "Supply Chain Orchestration": 1.1, "Supply Chain Planning": 1.2
                },
                // Initial Data Structure
                products: [
                    {
                        name: "Procurement",
                        modules: [
                            { name: "Purchasing", features: 30, personalizations: 20 },
                            { name: "Sourcing", features: 0, personalizations: 0 }
                        ]
                    }
                ]
            }
        },
        computed: {
            grandTotals() {
                let totalFeatures = 0;
                let totalPers = 0;
                let totalCSU = 0;

                // We need to calculate CSU based on the logic in the Python script
                // Since CSU calculation depends on whether it's the first product or not (Assessment/UAT/Migration),
                // we will do a simplified calculation here for the UI preview, 
                // but the Excel export will do the exact math.
                
                this.products.forEach((p, index) => {
                    const pFeatures = p.modules.reduce((sum, m) => sum + m.features, 0);
                    const pPers = p.modules.reduce((sum, m) => sum + m.personalizations, 0);
                    
                    totalFeatures += pFeatures;
                    totalPers += pPers;

                    // Simplified CSU estimation for UI (Actual logic is in Excel export)
                    // This is just a rough preview
                    const weight = this.getProductWeight(p.name);
                    const adoptionCSU = (pFeatures * 0.2) + (pFeatures * 16 * weight) + (pPers * 2); 
                    totalCSU += adoptionCSU;
                });

                return {
                    features: totalFeatures,
                    personalizations: totalPers,
                    csu: Math.round(totalCSU)
                };
            }
        },
        methods: {
            getProductWeight(name) {
                return this.productWeights[name] || 1.0;
            },
            addProduct() {
                this.products.push({
                    name: "Procurement",
                    modules: [{ name: "New Module", features: 0, personalizations: 0 }]
                });
            },
            removeProduct(index) {
                if(this.products.length > 1) {
                    this.products.splice(index, 1);
                } else {
                    alert("You must have at least one product.");
                }
            },
            addModule(pIndex) {
                this.products[pIndex].modules.push({ name: "New Module", features: 0, personalizations: 0 });
            },
            removeModule(pIndex, mIndex) {
                this.products[pIndex].modules.splice(mIndex, 1);
            },
            
            // --- EXCEL GENERATION LOGIC (Replicating Python Script) ---
            generateExcel() {
                const wb = XLSX.utils.book_new();

                // 1. Create Summary Sheet
                const summaryData = [
                    ["REDWOOD ADOPTION ESTIMATOR - SUMMARY"],
                    [],
                    ["Customer Name:", this.customerName],
                    ["Date:", "=TODAY()"],
                    [],
                    ["Product", "Module", "Features", "Personalizations", "Complexity", "CSU Features", "Actual CSU"]
                ];

                let grandTotalFeatures = 0;
                let grandTotalPers = 0;
                let summaryRowStart = 7; // 1-based index for Excel formulas

                this.products.forEach((product, pIdx) => {
                    const pFeatures = product.modules.reduce((sum, m) => sum + m.features, 0);
                    const pPers = product.modules.reduce((sum, m) => sum + m.personalizations, 0);
                    const weight = this.getProductWeight(product.name);

                    // Modules
                    product.modules.forEach(mod => {
                        summaryData.push([
                            product.name,
                            mod.name,
                            mod.features,
                            mod.personalizations,
                            "", "", ""
                        ]);
                    });

                    // Product Total
                    summaryData.push([
                        "Total",
                        "",
                        pFeatures,
                        pPers,
                        weight,
                        `='${product.name}'!G1000`, // Link to product sheet
                        `=F${summaryData.length + 1}` // Relative row calculation is tricky in array push, handled in formatting
                    ]);
                    
                    grandTotalFeatures += pFeatures;
                    grandTotalPers += pPers;
                });

                // Grand Total Row
                const lastRow = summaryData.length + 1;
                summaryData.push([
                    "Grand Total",
                    "",
                    grandTotalFeatures,
                    grandTotalPers,
                    this.products.length,
                    `=SUM(F${summaryRowStart}:F${lastRow-1})`,
                    `=F${lastRow}`
                ]);

                const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
                
                // Apply basic styling (SheetJS styling is limited in free version, using cell merging logic)
                wsSummary['!merges'] = [
                    { s: { r: 0, c: 0 }, e: { r: 0, c: 6 } } // Title merge
                ];
                
                // Set column widths
                wsSummary['!cols'] = [
                    { wch: 30 }, { wch: 35 }, { wch: 12 }, { wch: 18 }, { wch: 12 }, { wch: 15 }, { wch: 15 }
                ];

                XLSX.utils.book_append_sheet(wb, wsSummary, "Summary");

                // 2. Create Product Sheets
                let totalPersonalizationsAllProducts = this.grandTotals.personalizations;

                this.products.forEach((product, index) => {
                    const isFirstChild = index === 0;
                    const pFeatures = product.modules.reduce((sum, m) => sum + m.features, 0);
                    const pPers = product.modules.reduce((sum, m) => sum + m.personalizations, 0);
                    const weight = this.getProductWeight(product.name);

                    const ws = XLSX.utils.book_new(); // Create temp sheet logic
                    
                    // We build the data array for the product sheet
                    const pData = [];
                    
                    // Header
                    pData.push([`REDWOOD ADOPTION ESTIMATION - ${product.name.toUpperCase()}`]);
                    pData.push([]);
                    pData.push(["Customer:", `=Summary!B3`, "", "Features:", pFeatures]);
                    pData.push(["Date:", "=Summary!B4", "", "Personalizations:", pPers]);
                    pData.push([]);

                    let sectionNum = 1;
                    let currentRow = pData.length + 1;

                    // Helper to add section
                    const addSection = (title, activities) => {
                        pData.push([title]);
                        pData.push(["Activity", "Detailed Activity", "Non Prod", "Prod", "Qty", "Total", "CSUs"]);
                        
                        let startRow = pData.length + 1;
                        activities.forEach(act => {
                            // Formula: =(C+D)*E
                            let rowIdx = pData.length + 1;
                            pData.push([
                                act.name,
                                act.desc,
                                act.nonProd,
                                act.prod,
                                act.qty,
                                `=(C${rowIdx}+D${rowIdx})*E${rowIdx}`,
                                `=F${rowIdx}/2`
                            ]);
                        });

                        // Section Total
                        let totalRow = pData.length + 1;
                        pData.push([
                            "Section Total", "", "", "", "",
                            `=SUM(F${startRow}:F${totalRow-1})`,
                            `=SUM(G${startRow}:G${totalRow-1})`
                        ]);
                        pData.push([]); // Spacer
                    };

                    // 1. Assessment (First Product Only)
                    if (isFirstChild) {
                        addSection(`${sectionNum}. ASSESSMENT ACTIVITIES`, [
                            { name: "Discussion", desc: "Introduction of Redwood Features...", nonProd: 8, prod: 0, qty: 1 },
                            { name: "Documentation", desc: "CWB's and Adoption Document", nonProd: 16, prod: 0, qty: 1 },
                            { name: "Demo/Review", desc: "Walk Through...", nonProd: 8, prod: 0, qty: 1 }
                        ]);
                        sectionNum++;
                    }

                    // 2. Adoption (All Products)
                    addSection(`${sectionNum}. ADOPTION ACTIVITIES - ${product.name.toUpperCase()}`, [
                        { name: "Features Enablement", desc: "Enabling Feature by Feature...", nonProd: 0.1, prod: 0.1, qty: pFeatures },
                        { name: "Verification of Enabled Features at Config Level", desc: "Verified all features enablement", nonProd: 0.1, prod: 0.1, qty: pFeatures },
                        { name: "Verification of Enabled Features at UI", desc: `Verification... (Weight: ${weight}x)`, nonProd: 8 * weight, prod: 8 * weight, qty: 1 },
                        { name: "Enablement of Personalization", desc: "Redo personalizations...", nonProd: 2, prod: 0, qty: pPers },
                        { name: "Additional Personalization - Expected", desc: "Perform Additional personalization...", nonProd: 2, prod: 0, qty: Math.max(1, Math.floor(pPers * 0.1)) }
                    ]);
                    sectionNum++;

                    // 3. UAT (First Product Only)
                    if (isFirstChild) {
                        addSection(`${sectionNum}. UNIT TESTING ACTIVITIES AND UAT ASSISTANCE`, [
                            { name: "Perform Unit Testing...", desc: "Detailed column-by-column comparison...", nonProd: 40, prod: 0, qty: 1 },
                            { name: "Comparison between Classic vs Redwood - W.O", desc: "Column by Column comparison...", nonProd: 24, prod: 0, qty: 1 },
                            { name: "Assist in Test instance...", desc: "Assist in Test instance...", nonProd: 24, prod: 0, qty: 1 }
                        ]);
                        sectionNum++;
                    }

                    // 4. Migration (First Product Only)
                    if (isFirstChild) {
                        addSection(`${sectionNum}. MIGRATION ACTIVITIES`, [
                            { name: "Configure Setups...", desc: "Deploy to non-Prod...", nonProd: 0.1, prod: 0.1, qty: totalPersonalizationsAllProducts },
                            { name: "Configuration of Setups...", desc: "Production Migration...", nonProd: 0, prod: 1, qty: totalPersonalizationsAllProducts },
                            { name: "Assist Customer...", desc: "Optional migration assist...", nonProd: 0, prod: 1, qty: 0 }
                        ]);
                        sectionNum++;
                    }

                    // 5. Hypercare (First Product Only)
                    if (isFirstChild) {
                        const hypercareQty = Math.max(8, Math.floor(totalPersonalizationsAllProducts * 0.2));
                        addSection(`${sectionNum}. POST-GO-LIVE HYPERCARE SUPPORT`, [
                            { name: "Post Go-live Support", desc: "Hypercare for 3 weeks...", nonProd: 0, prod: 4, qty: hypercareQty }
                        ]);
                    }

                    // Grand Total Row (Row 1000 logic simulated by summing section totals)
                    // In SheetJS, finding specific rows for formulas is hard without parsing the whole sheet.
                    // We will add a Grand Total at the bottom.
                    const grandTotalRow = pData.length + 1;
                    // We need to find all "Section Total" rows. 
                    // Since we are building the array sequentially, we can track their indices.
                    // For simplicity in this web version, we will sum the F column of the whole sheet minus headers.
                    pData.push([
                        "GRAND TOTAL", "", "", "", "",
                        `=SUM(F2:F${grandTotalRow-1})`, 
                        `=SUM(G2:G${grandTotalRow-1})`
                    ]);

                    const wsProduct = XLSX.utils.aoa_to_sheet(pData);
                    
                    // Merges
                    wsProduct['!merges'] = [
                        { s: { r: 0, c: 0 }, e: { r: 0, c: 6 } }, // Title
                        { s: { r: 2, c: 1 }, e: { r: 2, c: 2 } }, // Customer Value
                        { s: { r: 3, c: 1 }, e: { r: 3, c: 2 } }, // Date Value
                        // Section Headers merges would go here, skipping for brevity in JS version
                    ];

                    wsProduct['!cols'] = [
                        { wch: 35 }, { wch: 60 }, { wch: 12 }, { wch: 12 }, { wch: 8 }, { wch: 15 }, { wch: 12 }
                    ];

                    XLSX.utils.book_append_sheet(wb, wsProduct, product.name);
                });

                // Save
                XLSX.writeFile(wb, "Redwood_Adoption_Estimator.xlsx");
            }
        }
    }).mount('#app');
</script>

</body>
</html>
