<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Redwood Adoption Estimator (Internal)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
/* Simplified Internal Tool Styling */
body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: #f4f4f4;
    margin: 0;
    color: #333;
}
.hidden { display: none !important; }

/* Login Screen */
.login-container {
    max-width: 400px;
    margin: 100px auto;
    padding: 30px;
    background: #fff;
    border-radius: 5px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    text-align: center;
}
.login-container h3 { margin-top: 0; color: #333; }
.login-container input {
    width: 100%;
    padding: 10px;
    margin: 10px 0;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
}
.login-container button {
    width: 100%;
    padding: 10px;
    margin: 5px 0;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
}
.btn-user { background: #0056b3; color: white; }
.btn-user:hover { background: #004494; }
.btn-admin { background: #fff; color: #333; border: 1px solid #333; }
.btn-admin:hover { background: #f0f0f0; }
.btn-logout {
    background: #fff;
    color: #333;
    border: 1px solid #333;
    padding: 5px 15px;
    cursor: pointer;
    font-weight: bold;
}
.btn-logout:hover { background: #f0f0f0; }

/* App Screen */
.header {
    background: #333;
    color: #fff;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.header h2 { margin: 0; font-size: 20px; }

.dashboard {
    display: flex;
    gap: 20px;
    padding: 20px;
    background: #fff;
    border-bottom: 1px solid #ccc;
    flex-wrap: wrap;
}
.dashboard div { display: flex; flex-direction: column; }
.dashboard label { font-weight: bold; margin-bottom: 5px; font-size: 13px; }
.dashboard input {
    padding: 5px;
    border: 1px solid #ccc;
    border-radius: 3px;
    background: #eee;
    width: 200px;
}

.tabs {
    display: flex;
    background: #fff;
    padding: 0 20px;
    border-bottom: 2px solid #ccc;
}
.tab {
    padding: 10px 20px;
    cursor: pointer;
    font-weight: bold;
    border-bottom: 3px solid transparent;
    transition: all 0.2s;
}
.tab:hover { background: #f0f0f0; }
.tab.active {
    border-bottom: 3px solid #0056b3;
    color: #0056b3;
}

.tab-content { display: none; padding: 20px; }
.tab-content.active { display: block; }

/* Sections & Tables */
.section {
    background: #fff;
    border: 1px solid #ccc;
    margin-bottom: 20px;
    border-radius: 4px;
    overflow: hidden;
}
.section-header {
    background: #a5a5a5;
    color: #fff;
    padding: 10px 15px;
    font-weight: bold;
}
.product-header {
    background: #333;
    color: #fff;
    padding: 10px 15px;
    font-weight: bold;
}

table { width: 100%; border-collapse: collapse; }
th, td {
    padding: 8px;
    border: 1px solid #ddd;
    text-align: center;
    font-size: 14px;
}
th { 
    background: #9bc2e6; 
    font-weight: bold; 
    color: #fff;
}
td.task-name { text-align: left; font-weight: 500; }
td.task-details { text-align: left; font-size: 13px; color: #666; }

input[type="number"] {
    width: 60px;
    padding: 4px;
    text-align: center;
    border: 1px solid #ccc;
    border-radius: 3px;
}

tr.section-total { 
    background: #e7e6e6; 
    font-weight: bold; 
}
tr.grand-total { 
    background: #595959; 
    font-weight: bold; 
    font-size: 15px;
    color: #fff;
}
tr.product-total {
    background: #c6e0b4;
    font-weight: bold;
}

.btn-download {
    background: #0056b3;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    margin: 10px;
    font-size: 14px;
}
.btn-download:hover { background: #004494; }

.module-toggle-btn {
    padding: 4px 12px;
    border: 1px solid #ccc;
    border-radius: 15px;
    cursor: pointer;
    font-size: 12px;
    background: #fff;
    transition: all 0.2s;
}
.module-toggle-btn.selected { 
    background: #e8f5e9; 
    border-color: #2e7d32; 
    color: #2e7d32; 
    font-weight: bold; 
}
.module-toggle-btn.unselected { 
    background: #ffebee; 
    border-color: #c62828; 
    color: #c62828; 
    font-weight: bold; 
}
.module-toggle-btn:hover {
    transform: scale(1.05);
}

.admin-controls { 
    background: #f9f9f9; 
    padding: 15px; 
    border: 1px solid #ccc; 
    margin-bottom: 20px; 
    border-radius: 4px;
}
.admin-controls h3 { margin-top: 0; color: #333; }

.file-input-wrapper {
    margin: 15px 0;
}
.file-input-wrapper input[type="file"] {
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 3px;
    width: 100%;
    box-sizing: border-box;
}

.error-message {
    color: #c62828;
    font-size: 14px;
    margin-top: 10px;
    font-weight: bold;
}

/* Responsive */
@media (max-width: 768px) {
    .dashboard {
        flex-direction: column;
    }
    .dashboard input {
        width: 100%;
    }
    .tabs {
        flex-direction: column;
    }
    .tab {
        width: 100%;
        border-bottom: 1px solid #ccc;
    }
}
</style>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen" class="login-container">
    <h3>Redwood Adoption Estimator</h3>
    <p>Internal Tool - Select Access Level</p>
    <button class="btn-user" onclick="loginAsUser()">Continue as User</button>
    <button class="btn-admin" onclick="showAdminLogin()">Admin Login</button>
    <div id="adminLoginForm" class="hidden" style="margin-top:20px;">
        <input type="password" id="adminPassword" placeholder="Enter admin password">
        <button class="btn-admin" onclick="loginAsAdmin()">Login</button>
        <div id="loginError" class="error-message hidden">Incorrect password</div>
    </div>
</div>

<!-- App Screen -->
<div id="appScreen" class="hidden">
    <div class="header">
        <h2>Redwood Adoption Estimator</h2>
        <div>
            <span id="userBadge" style="margin-right:10px; font-weight:bold;"></span>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
    </div>
    
    <div class="dashboard">
        <div>
            <label>Customer Name</label>
            <input id="customerName" value="Global Enterprises"/>
        </div>
        <div>
            <label>Modules Selected</label>
            <input id="moduleCount" readonly/>
        </div>
        <div>
            <label>Products Selected</label>
            <input id="productCount" readonly/>
        </div>
        <div>
            <label>Total Features</label>
            <input id="featureCount" readonly/>
        </div>
        <div>
            <label>Total Personalizations</label>
            <input id="persCount" readonly/>
        </div>
    </div>

    <div class="tabs" id="tabsContainer"></div>

    <div id="selector" class="tab-content">
        <div id="productContainer"></div>
    </div>

    <div id="estimation" class="tab-content">
        <div id="formContainer"></div>
        <div style="text-align:center; margin:20px 0;">
            <button class="btn-download" onclick="downloadEstimation()">ðŸ“¥ Download Excel Report</button>
            <button class="btn-download" onclick="downloadJSON()">ðŸ’¾ Download JSON Config</button>
        </div>
    </div>

    <div id="admin" class="tab-content">
        <div class="admin-controls">
            <h3>Configuration Management</h3>
            <p>Upload or download JSON configuration to save/restore estimation settings.</p>
            <div class="file-input-wrapper">
                <input type="file" id="jsonFile" accept=".json">
                <button class="btn-download" onclick="uploadJSON()" style="background:#333; margin-left:10px;">Upload JSON</button>
            </div>
        </div>
        <div id="adminContainer"></div>
    </div>
</div>

<script>
// ============================================
// CONFIGURATION & DATA
// ============================================
const ADMIN_PASSWORD = "admin";
let currentUser = null;
let personalizationCounts = {};
let selectedModules = new Set();

// Product weights for complexity-based estimation
const PRODUCT_WEIGHTS = {
    "SCM Common Components": 0.5,
    "Inventory Management": 1.2,
    "Maintenance": 1.2,
    "Manufacturing": 1.5,
    "Order Management": 1.0,
    "Collaboration Messaging Framework": 1.0,
    "Procurement": 1.0,
    "Product Hub": 1.0,
    "Purchasing": 1.0,
    "Quality Management": 1.1,
    "Self Service Procurement & RSSP": 1.0,
    "Supply Chain Collaboration": 1.0,
    "Supply Chain Orchestration": 1.1,
    "Supply Chain Planning": 1.2
};

// Pre-loaded data from user input (Turn 1)
const PRODUCTS = [
    { name: "Procurement", weight: 1.0 },
    { name: "Order Management", weight: 1.0 }
];

const MODULES = [
    { name: "Purchasing", count: 30, product: "Procurement" },
    { name: "Procurement Contracts", count: 3, product: "Procurement" },
    { name: "Self Service Procurement", count: 0, product: "Procurement" },
    { name: "Sourcing", count: 0, product: "Procurement" },
    { name: "Order Management", count: 15, product: "Order Management" },
    { name: "Pricing", count: 4, product: "Order Management" }
];

// Pre-calculated Personalizations (from Turn 1 input)
const INPUT_PERSONALIZATIONS = {
    "Procurement": { "Purchasing": 20, "Procurement Contracts": 0, "Self Service Procurement": 0, "Sourcing": 0 },
    "Order Management": { "Order Management": 22, "Pricing": 0 }
};

// Default Overview Tasks (Service Kick-off = 0 as per Turn 1)
const DEFAULT_OVERVIEW = [
    { name:"Service Kick-off", detail:"Validate Pre-Adoption File and Helper Tool Output", nonProd:0, prod:0, qty:1 },
    { name:"Service Kick-off", detail:"Impact Assessment for Redwood and Personalization", nonProd:0, prod:0, qty:1 }
];

// Default Hypercare Tasks
const DEFAULT_HYPERCARE = [
    { name:"Production Migration", detail:"Per personalization time / Env", nonProd:0, prod:0.5, qty:0 },
    { name:"Issue Resolution", detail:"Hypercare Support (3 weeks)", nonProd:0, prod:4, qty:0 }
];

// Main Configuration Object
let CONFIG = {
    overview: JSON.parse(JSON.stringify(DEFAULT_OVERVIEW)),
    products: {},
    hypercare: JSON.parse(JSON.stringify(DEFAULT_HYPERCARE))
};

// ============================================
// INITIALIZATION FUNCTIONS
// ============================================
function showAdminLogin() {
    document.getElementById('adminLoginForm').classList.remove('hidden');
}

function loginAsUser() {
    currentUser = 'user';
    initializeApp();
}

function loginAsAdmin() {
    const pwd = document.getElementById('adminPassword').value;
    const errorDiv = document.getElementById('loginError');
    if (pwd === ADMIN_PASSWORD) {
        currentUser = 'admin';
        errorDiv.classList.add('hidden');
        initializeApp();
    } else {
        errorDiv.classList.remove('hidden');
    }
}

function logout() {
    currentUser = null;
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('appScreen').classList.add('hidden');
    document.getElementById('adminPassword').value = '';
    document.getElementById('adminLoginForm').classList.add('hidden');
    document.getElementById('loginError').classList.add('hidden');
}

function initializeApp() {
    const loginScreen = document.getElementById('loginScreen');
    const appScreen = document.getElementById('appScreen');
    
    if(loginScreen) loginScreen.classList.add('hidden');
    if(appScreen) appScreen.classList.remove('hidden');

    if (currentUser === 'admin') {
        document.getElementById('userBadge').textContent = 'Admin';
        renderTabs(['selector', 'estimation', 'admin']);
    } else {
        document.getElementById('userBadge').textContent = 'User';
        renderTabs(['selector', 'estimation']);
    }

    // Pre-select modules based on input data
    MODULES.forEach(m => {
        if(m.count > 0) {
            selectedModules.add(m.name);
            if(INPUT_PERSONALIZATIONS[m.product] && INPUT_PERSONALIZATIONS[m.product][m.name] !== undefined) {
                personalizationCounts[m.product] = INPUT_PERSONALIZATIONS[m.product][m.name];
            } else {
                personalizationCounts[m.product] = 0;
            }
        }
    });

    renderSelector();
    rebuildProductConfig();
    renderEstimation();
    activateTab('estimation');
}

// ============================================
// TAB & RENDERING FUNCTIONS
// ============================================
function renderTabs(tabs) {
    const container = document.getElementById('tabsContainer');
    container.innerHTML = '';
    const tabLabels = { 
        selector: '1. Module Selection', 
        estimation: '2. Estimation Report', 
        admin: '3. Admin Configuration' 
    };
    tabs.forEach(tabId => {
        const tab = document.createElement('div');
        tab.className = 'tab';
        tab.textContent = tabLabels[tabId];
        tab.onclick = () => activateTab(tabId);
        container.appendChild(tab);
    });
}

function activateTab(id){
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    const tabs = Array.from(document.querySelectorAll('.tab'));
    const idx = tabs.findIndex(t => t.textContent.includes(
        id === 'selector' ? 'Module' : id === 'estimation' ? 'Estimation' : 'Admin'
    ));
    if(idx >= 0) tabs[idx].classList.add('active');
    document.getElementById(id).classList.add('active');
    if (id === 'admin' && currentUser === 'admin') renderAdmin();
}

function renderSection(parent, title, tasks, editable, isProduct = false){
    if(tasks.length === 0) return;
    
    const sec = document.createElement("div");
    sec.className = "section";
    const headerClass = isProduct ? "product-header" : "section-header";
    sec.innerHTML = `<div class="${headerClass}">${title}</div>`;
    
    let rows = "";
    let sectionTotal = 0;
    let sectionCSU = 0;
    
    tasks.forEach((t, i) => {
        const total = (t.nonProd + t.prod) * t.qty;
        const csu = total / 2;
        sectionTotal += total;
        sectionCSU += csu;
        const sectionKey = title.replace(/[^a-zA-Z0-9]/g, '_');
        
        rows += `<tr>
            <td class="task-name">${t.name}</td>
            <td class="task-details">${t.detail}</td>
            <td>${editable ? `<input type="number" step="0.1" value="${t.nonProd}" data-section="${sectionKey}" data-index="${i}" data-field="nonProd" class="editable-field">` : t.nonProd.toFixed(1)}</td>
            <td>${editable ? `<input type="number" step="0.1" value="${t.prod}" data-section="${sectionKey}" data-index="${i}" data-field="prod" class="editable-field">` : t.prod.toFixed(1)}</td>
            <td>${editable ? `<input type="number" value="${t.qty}" data-section="${sectionKey}" data-index="${i}" data-field="qty" class="editable-field">` : t.qty}</td>
            <td>${total.toFixed(1)}</td>
            <td>${csu.toFixed(1)}</td>
        </tr>`;
    });
    
    rows += `<tr class="section-total">
        <td colspan="5" style="text-align:right;">Section Total:</td>
        <td>${sectionTotal.toFixed(1)}</td>
        <td>${sectionCSU.toFixed(1)}</td>
    </tr>`;
    
    sec.innerHTML += `<table>
        <thead><tr><th>Activity</th><th>Detailed Activity</th><th>Non Prod</th><th>Prod</th><th>Qty</th><th>Total</th><th>CSUs</th></tr></thead>
        <tbody>${rows}</tbody>
    </table>`;
    parent.appendChild(sec);
}

function renderSelector(){
    const container = document.getElementById('productContainer');
    container.innerHTML = '';
    updateSummary();
    
    PRODUCTS.forEach(product => {
        const productDiv = document.createElement('div');
        productDiv.className = 'section';
        const modulesInProduct = MODULES.filter(m => m.product === product.name);
        if (!personalizationCounts[product.name]) personalizationCounts[product.name] = 0;
        const safeId = product.name.replace(/\s+/g, '_');
        
        productDiv.innerHTML = `
            <div class="product-header">${product.name} (Weight: ${product.weight})</div>
            <div style="padding:10px; background:#f9f9f9; border-bottom:1px solid #ddd;">
                <label style="font-weight:bold;">Personalizations: 
                    <input type="number" min="0" value="${personalizationCounts[product.name]}" 
                           style="width:80px; margin-left:8px;" 
                           onchange="updatePersonalization('${product.name}', this.value)">
                </label>
            </div>
            <table>
                <thead><tr><th style="width:50%">Module</th><th>Features</th><th>Selected</th></tr></thead>
                <tbody id="mods_${safeId}"></tbody>
            </table>`;
        container.appendChild(productDiv);
        
        const tbody = document.getElementById(`mods_${safeId}`);
        modulesInProduct.forEach(mod => {
            const isSelected = selectedModules.has(mod.name);
            const row = document.createElement('tr');
            row.innerHTML = `
                <td style="text-align:left; padding:8px;">${mod.name}</td>
                <td>${mod.count}</td>
                <td><button class="module-toggle-btn ${isSelected?'selected':'unselected'}" 
                            onclick="toggleModule('${mod.name.replace(/'/g,"\\'")}')">
                        ${isSelected ? 'âœ“ Yes' : 'âœ— No'}
                    </button></td>`;
            tbody.appendChild(row);
        });
    });
}

function toggleModule(moduleName) {
    if (selectedModules.has(moduleName)) {
        selectedModules.delete(moduleName);
    } else {
        selectedModules.add(moduleName);
    }
    renderSelector();
    rebuildProductConfig();
    renderEstimation();
}

function updatePersonalization(productName, value) {
    personalizationCounts[productName] = parseInt(value) || 0;
    rebuildProductConfig();
    renderEstimation();
}

function updateSummary() {
    document.getElementById('moduleCount').value = selectedModules.size;
    
    const selectedProducts = new Set();
    let totalFeatures = 0;
    let totalPers = 0;
    
    selectedModules.forEach(name => {
        const mod = MODULES.find(m => m.name === name);
        if (mod) {
            selectedProducts.add(mod.product);
            totalFeatures += mod.count;
        }
    });
    
    selectedProducts.forEach(p => {
        totalPers += personalizationCounts[p] || 0;
    });
    
    document.getElementById('productCount').value = selectedProducts.size;
    document.getElementById('featureCount').value = totalFeatures;
    document.getElementById('persCount').value = totalPers;
}

function rebuildProductConfig(){
    CONFIG.products = {};
    const selectedProducts = new Set();
    
    selectedModules.forEach(name => {
        const mod = MODULES.find(m => m.name === name);
        if (mod) selectedProducts.add(mod.product);
    });
    
    selectedProducts.forEach(productName => {
        const product = PRODUCTS.find(p => p.name === productName);
        let featureCount = 0;
        
        MODULES.filter(m => m.product === productName).forEach(m => {
            if (selectedModules.has(m.name)) featureCount += m.count;
        });
        
        const persCount = personalizationCounts[productName] || 0;
        const weight = product ? product.weight : 1.0;
        
        CONFIG.products[productName] = [
            { 
                name: "Features Enablement", 
                detail: "Enabling Feature by Feature by setup, Profile option, Opt-in Enablement", 
                nonProd: 0.1, prod: 0.1, qty: featureCount 
            },
            { 
                name: "Verification of Enabled Features at Config Level", 
                detail: "Once All the features are enabled, verified all features enablement", 
                nonProd: 0.1, prod: 0.1, qty: featureCount 
            },
            { 
                name: "Verification of Enabled Features at UI", 
                detail: `Verification of enabled functionality in Redwood UI (Product weight: ${weight}x)`, 
                nonProd: 8 * weight, prod: 8 * weight, qty: 1 
            },
            { 
                name: "Enablement of Personalization", 
                detail: "Redo personalizations. With the shift to Redwood architecture, many existing personalizations from Classic will not automatically migrate", 
                nonProd: 2, prod: 0, qty: persCount 
            },
            { 
                name: "Additional Personalization - Expected", 
                detail: "Perform Additional personalization based on customer testing and inputs during testing", 
                nonProd: 2, prod: 0, qty: persCount > 0 ? Math.max(1, Math.floor(persCount * 0.1)) : 0 
            },
            { 
                name: "Unit Testing w/o Personalization", 
                detail: "Testing of Standard Process by creating transaction", 
                nonProd: 24 * weight, prod: 0, qty: 1 
            },
            { 
                name: "Comparison between Classic vs Redwood", 
                detail: "Column by Column comparison between Classic and Redwood to ensure everything is covered", 
                nonProd: 16 * weight, prod: 0, qty: 1 
            },
            { 
                name: "Testing After Personalizations", 
                detail: "This can vary with number of Features and business process and Complexity", 
                nonProd: 40, prod: 0, qty: persCount > 0 ? 1 : 0 
            }
        ];
    });
    
    // Calculate total personalizations for hypercare
    let totalPers = 0;
    selectedProducts.forEach(p => { 
        totalPers += personalizationCounts[p] || 0; 
    });
    
    CONFIG.hypercare[0].qty = totalPers;
    CONFIG.hypercare[1].qty = Math.max(3, Math.ceil(totalPers * 0.2));
}

function renderEstimation(){
    const c = document.getElementById("formContainer");
    c.innerHTML = "";
    
    // Overview Section
    renderSection(c, "Service Kick-off", CONFIG.overview, false);
    
    // Product Sections
    Object.keys(CONFIG.products).forEach(productName => {
        renderSection(c, `Product: ${productName}`, CONFIG.products[productName], false, true);
    });
    
    // Hypercare Section
    renderSection(c, "Migration & Hypercare", CONFIG.hypercare, false);
    
    // Grand Total
    renderGrandTotal(c);
}

function renderAdmin(){
    const c = document.getElementById("adminContainer");
    c.innerHTML = "";
    
    renderSection(c, "Service Kick-off", CONFIG.overview, true);
    
    Object.keys(CONFIG.products).forEach(productName => {
        renderSection(c, `Product: ${productName}`, CONFIG.products[productName], true, true);
    });
    
    renderSection(c, "Migration & Hypercare", CONFIG.hypercare, true);
    renderGrandTotal(c);
}

function renderGrandTotal(parent) {
    let grandTotal = 0;
    let grandCSU = 0;
    
    CONFIG.overview.forEach(t => { 
        const total = (t.nonProd + t.prod) * t.qty; 
        grandTotal += total; 
        grandCSU += total/2; 
    });
    
    Object.values(CONFIG.products).forEach(tasks => { 
        tasks.forEach(t => { 
            const total = (t.nonProd + t.prod) * t.qty; 
            grandTotal += total; 
            grandCSU += total/2; 
        }); 
    });
    
    CONFIG.hypercare.forEach(t => { 
        const total = (t.nonProd + t.prod) * t.qty; 
        grandTotal += total; 
        grandCSU += total/2; 
    });
    
    const sec = document.createElement("div");
    sec.className = "section";
    sec.style.marginTop = "30px";
    sec.innerHTML = `
        <div class="section-header" style="background:#595959; font-size:18px;">ðŸ“Š GRAND TOTAL</div>
        <table>
            <thead>
                <tr style="background:#f4f4f4;">
                    <th colspan="5" style="text-align:right; font-size:16px;">TOTAL ESTIMATION</th>
                    <th style="font-size:16px; background:#c6e0b4;">${grandTotal.toFixed(1)} Hours</th>
                    <th style="font-size:16px; background:#c6e0b4;">${grandCSU.toFixed(1)} CSU</th>
                </tr>
            </thead>
        </table>`;
    parent.appendChild(sec);
}

// ============================================
// EVENT HANDLING
// ============================================
document.addEventListener('input', function(e) {
    if (e.target.classList.contains('editable-field')) {
        const sectionKey = e.target.getAttribute('data-section');
        const index = parseInt(e.target.getAttribute('data-index'));
        const field = e.target.getAttribute('data-field');
        const value = field === 'qty' ? (parseInt(e.target.value)||0) : (parseFloat(e.target.value)||0);
        updateTask(sectionKey, index, field, value);
    }
});

function updateTask(sectionKey, idx, field, value){
    if(sectionKey === "Service_Kick_off" && CONFIG.overview[idx]) {
        CONFIG.overview[idx][field] = value;
    }
    else if(sectionKey.includes("Migration") && CONFIG.hypercare[idx]) {
        CONFIG.hypercare[idx][field] = value;
    }
    else if(sectionKey.includes("Product")) {
        let productName = sectionKey.replace(/^Product_+/, "").replace(/_/g, " ");
        let matchingProduct = Object.keys(CONFIG.products).find(p => p === productName);
        if (!matchingProduct) {
            matchingProduct = Object.keys(CONFIG.products).find(p => 
                p.replace(/[^a-zA-Z0-9]/g,'').toLowerCase() === productName.replace(/[^a-zA-Z0-9]/g,'').toLowerCase()
            );
        }
        if(matchingProduct && CONFIG.products[matchingProduct][idx]) {
            CONFIG.products[matchingProduct][idx][field] = value;
        }
    }
    renderEstimation();
    if(currentUser === 'admin') renderAdmin();
}

// ============================================
// EXCEL EXPORT WITH STYLING (Python-like)
// ============================================
function downloadEstimation(){
    const customerName = document.getElementById('customerName').value || 'Customer';
    const wb = XLSX.utils.book_new();
    
    // ========================================
    // SUMMARY SHEET
    // ========================================
    const summaryData = [];
    let row = 1;
    
    // Title
    summaryData.push([{v:"REDWOOD ADOPTION ESTIMATOR - SUMMARY", s:{font:{bold:true, sz:16}, alignment:{horizontal:"center"}}}]);
    row += 2;
    
    // Customer Info
    summaryData.push([{v:"Customer Name:"}, {v:customerName, s:{font:{bold:true, color:{rgb:"0000FF"}}}}]);
    row += 1;
    summaryData.push([{v:"Date:"}, {v:new Date().toLocaleDateString()}]);
    row += 2;
    
    // Headers
    const summaryHeaders = ["Product", "Module", "Features", "Personalizations", "Complexity", "CSU Features", "Actual CSU"];
    const headerRow = summaryHeaders.map(h => ({
        v: h,
        s: {
            font: {bold:true, color:{rgb:"FFFFFF"}, sz:11},
            fill: {fgColor:{rgb:"9BC2E6"}},
            alignment: {horizontal:"center", vertical:"center"},
            border: {
                top:{style:"thin", color:{rgb:"BDBDBD"}},
                bottom:{style:"thin", color:{rgb:"BDBDBD"}},
                left:{style:"thin", color:{rgb:"BDBDBD"}},
                right:{style:"thin", color:{rgb:"BDBDBD"}}
            }
        }
    }));
    summaryData.push(headerRow);
    row += 1;
    
    // Module Data
    let grandTotalFeatures = 0;
    let grandTotalPers = 0;
    let productCSUTotals = {};
    
    MODULES.forEach(mod => {
        if(selectedModules.has(mod.name)) {
            const prodName = mod.product;
            const featCount = mod.count;
            const persCount = personalizationCounts[prodName] || 0;
            
            // Calculate product CSU
            let prodTotalHours = 0;
            if(CONFIG.products[prodName]) {
                CONFIG.products[prodName].forEach(t => {
                    prodTotalHours += (t.nonProd + t.prod) * t.qty;
                });
            }
            const prodCSU = prodTotalHours / 2;
            
            if(!productCSUTotals[prodName]) productCSUTotals[prodName] = 0;
            productCSUTotals[prodName] = prodCSU;
            
            summaryData.push([
                {v: prodName, s:{alignment:{horizontal:"left"}}},
                {v: mod.name, s:{alignment:{horizontal:"left"}}},
                {v: featCount, s:{alignment:{horizontal:"center"}}},
                {v: persCount, s:{alignment:{horizontal:"center"}}},
                {v: "", s:{alignment:{horizontal:"center"}}},
                {v: "", s:{alignment:{horizontal:"center"}}},
                {v: "", s:{alignment:{horizontal:"center"}}}
            ]);
            
            grandTotalFeatures += featCount;
            grandTotalPers += persCount;
        }
    });
    
    // Product Totals
    Object.keys(productCSUTotals).forEach(prodName => {
        let prodFeat = 0;
        let prodPers = personalizationCounts[prodName] || 0;
        
        MODULES.filter(m => m.product === prodName && selectedModules.has(m.name))
               .forEach(m => prodFeat += m.count);
        
        summaryData.push([
            {v: "Total", s:{font:{bold:true}, fill:{fgColor:{rgb:"C6E0B4"}}, alignment:{horizontal:"left"}}},
            {v: "", s:{fill:{fgColor:{rgb:"C6E0B4"}}}},
            {v: prodFeat, s:{font:{bold:true}, fill:{fgColor:{rgb:"C6E0B4"}}, alignment:{horizontal:"center"}}},
            {v: prodPers, s:{font:{bold:true}, fill:{fgColor:{rgb:"C6E0B4"}}, alignment:{horizontal:"center"}}},
            {v: PRODUCT_WEIGHTS[prodName] || 1.0, s:{font:{bold:true}, fill:{fgColor:{rgb:"C6E0B4"}}, alignment:{horizontal:"center"}}},
            {v: productCSUTotals[prodName].toFixed(1), s:{font:{bold:true}, fill:{fgColor:{rgb:"C6E0B4"}}, alignment:{horizontal:"center"}}},
            {v: productCSUTotals[prodName].toFixed(1), s:{font:{bold:true}, fill:{fgColor:{rgb:"C6E0B4"}}, alignment:{horizontal:"center"}}}
        ]);
    });
    
    // Grand Total
    let grandTotalCSU = Object.values(productCSUTotals).reduce((a,b) => a+b, 0);
    summaryData.push([
        {v: "Grand Total", s:{font:{bold:true, sz:12}, fill:{fgColor:{rgb:"C6E0B4"}}, alignment:{horizontal:"left"}}},
        {v: "", s:{fill:{fgColor:{rgb:"C6E0B4"}}}},
        {v: grandTotalFeatures, s:{font:{bold:true}, fill:{fgColor:{rgb:"C6E0B4"}}, alignment:{horizontal:"center"}}},
        {v: grandTotalPers, s:{font:{bold:true}, fill:{fgColor:{rgb:"C6E0B4"}}, alignment:{horizontal:"center"}}},
        {v: Object.keys(productCSUTotals).length, s:{font:{bold:true}, fill:{fgColor:{rgb:"C6E0B4"}}, alignment:{horizontal:"center"}}},
        {v: grandTotalCSU.toFixed(1), s:{font:{bold:true}, fill:{fgColor:{rgb:"C6E0B4"}}, alignment:{horizontal:"center"}}},
        {v: grandTotalCSU.toFixed(1), s:{font:{bold:true}, fill:{fgColor:{rgb:"C6E0B4"}}, alignment:{horizontal:"center"}}}
    ]);
    
    const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
    wsSummary['!cols'] = [
        {wch:30}, {wch:35}, {wch:12}, {wch:18}, {wch:12}, {wch:15}, {wch:15}
    ];
    XLSX.utils.book_append_sheet(wb, wsSummary, "Summary");
    
    // ========================================
    // ESTIMATION SHEET
    // ========================================
    const estData = [];
    row = 1;
    
    // Title
    estData.push([{v:"REDWOOD ADOPTION ESTIMATION", s:{font:{bold:true, sz:16}, alignment:{horizontal:"center"}}}]);
    row += 2;
    
    // Customer Info
    estData.push([{v:"Customer:"}, {v:customerName, s:{font:{bold:true, color:{rgb:"0000FF"}}}}]);
    row += 1;
    estData.push([{v:"Date:"}, {v:new Date().toLocaleDateString()}]);
    row += 2;
    
    // Headers
    const estHeaders = ["Activity", "Detailed Activity", "Non Prod", "Prod", "Qty", "Total", "CSUs"];
    const estHeaderRow = estHeaders.map(h => ({
        v: h,
        s: {
            font: {bold:true, color:{rgb:"FFFFFF"}, sz:11},
            fill: {fgColor:{rgb:"9BC2E6"}},
            alignment: {horizontal:"center", vertical:"center"},
            border: {
                top:{style:"thin", color:{rgb:"BDBDBD"}},
                bottom:{style:"thin", color:{rgb:"BDBDBD"}},
                left:{style:"thin", color:{rgb:"BDBDBD"}},
                right:{style:"thin", color:{rgb:"BDBDBD"}}
            }
        }
    }));
    estData.push(estHeaderRow);
    row += 1;
    
    // Overview Section
    let sectionStart = estData.length;
    estData.push([{v:"SERVICE KICK-OFF", s:{font:{bold:true, color:{rgb:"FFFFFF"}, sz:11}, fill:{fgColor:{rgb:"A5A5A5"}}, alignment:{horizontal:"center"}}}]);
    CONFIG.overview.forEach(t => {
        const total = (t.nonProd + t.prod) * t.qty;
        const csu = total / 2;
        estData.push([
            {v: t.name, s:{alignment:{horizontal:"left"}}},
            {v: t.detail, s:{alignment:{horizontal:"left", wrapText:true}}},
            {v: t.nonProd, s:{alignment:{horizontal:"center"}}},
            {v: t.prod, s:{alignment:{horizontal:"center"}}},
            {v: t.qty, s:{alignment:{horizontal:"center"}}},
            {v: total, s:{alignment:{horizontal:"center"}}},
            {v: csu, s:{alignment:{horizontal:"center"}}}
        ]);
    });
    // Section Total
    let sectionTotal = CONFIG.overview.reduce((sum, t) => sum + (t.nonProd + t.prod) * t.qty, 0);
    let sectionCSU = sectionTotal / 2;
    estData.push([
        {v:"Section Total", s:{font:{bold:true}, fill:{fgColor:{rgb:"E7E6E6"}}, alignment:{horizontal:"right"}}, t:{t:1, r:5}},
        {v:"", s:{fill:{fgColor:{rgb:"E7E6E6"}}}},
        {v:"", s:{fill:{fgColor:{rgb:"E7E6E6"}}}},
        {v:"", s:{fill:{fgColor:{rgb:"E7E6E6"}}}},
        {v:"", s:{fill:{fgColor:{rgb:"E7E6E6"}}}},
        {v:sectionTotal.toFixed(1), s:{font:{bold:true}, fill:{fgColor:{rgb:"E7E6E6"}}, alignment:{horizontal:"center"}}},
        {v:sectionCSU.toFixed(1), s:{font:{bold:true}, fill:{fgColor:{rgb:"E7E6E6"}}, alignment:{horizontal:"center"}}}
    ]);
    estData.push([]); // Empty row
    
    // Product Sections
    let grandTotalHours = sectionTotal;
    let grandTotalCSUHours = sectionCSU;
    
    Object.entries(CONFIG.products).forEach(([prodName, tasks]) => {
        sectionStart = estData.length;
        estData.push([{v:`ADOPTION ACTIVITIES - ${prodName.toUpperCase()}`, s:{font:{bold:true, color:{rgb:"FFFFFF"}, sz:11}, fill:{fgColor:{rgb:"A5A5A5"}}, alignment:{horizontal:"center"}}}]);
        
        sectionTotal = 0;
        sectionCSU = 0;
        
        tasks.forEach(t => {
            const total = (t.nonProd + t.prod) * t.qty;
            const csu = total / 2;
            sectionTotal += total;
            sectionCSU += csu;
            estData.push([
                {v: t.name, s:{alignment:{horizontal:"left"}}},
                {v: t.detail, s:{alignment:{horizontal:"left", wrapText:true}}},
                {v: t.nonProd, s:{alignment:{horizontal:"center"}}},
                {v: t.prod, s:{alignment:{horizontal:"center"}}},
                {v: t.qty, s:{alignment:{horizontal:"center"}}},
                {v: total, s:{alignment:{horizontal:"center"}}},
                {v: csu, s:{alignment:{horizontal:"center"}}}
            ]);
        });
        
        // Section Total
        estData.push([
            {v:"Section Total", s:{font:{bold:true}, fill:{fgColor:{rgb:"E7E6E6"}}, alignment:{horizontal:"right"}}},
            {v:"", s:{fill:{fgColor:{rgb:"E7E6E6"}}}},
            {v:"", s:{fill:{fgColor:{rgb:"E7E6E6"}}}},
            {v:"", s:{fill:{fgColor:{rgb:"E7E6E6"}}}},
            {v:"", s:{fill:{fgColor:{rgb:"E7E6E6"}}}},
            {v:sectionTotal.toFixed(1), s:{font:{bold:true}, fill:{fgColor:{rgb:"E7E6E6"}}, alignment:{horizontal:"center"}}},
            {v:sectionCSU.toFixed(1), s:{font:{bold:true}, fill:{fgColor:{rgb:"E7E6E6"}}, alignment:{horizontal:"center"}}}
        ]);
        estData.push([]);
        
        grandTotalHours += sectionTotal;
        grandTotalCSUHours += sectionCSU;
    });
    
    // Hypercare Section
    sectionStart = estData.length;
    estData.push([{v:"MIGRATION & HYPERCARE", s:{font:{bold:true, color:{rgb:"FFFFFF"}, sz:11}, fill:{fgColor:{rgb:"A5A5A5"}}, alignment:{horizontal:"center"}}}]);
    
    sectionTotal = 0;
    sectionCSU = 0;
    
    CONFIG.hypercare.forEach(t => {
        const total = (t.nonProd + t.prod) * t.qty;
        const csu = total / 2;
        sectionTotal += total;
        sectionCSU += csu;
        estData.push([
            {v: t.name, s:{alignment:{horizontal:"left"}}},
            {v: t.detail, s:{alignment:{horizontal:"left", wrapText:true}}},
            {v: t.nonProd, s:{alignment:{horizontal:"center"}}},
            {v: t.prod, s:{alignment:{horizontal:"center"}}},
            {v: t.qty, s:{alignment:{horizontal:"center"}}},
            {v: total, s:{alignment:{horizontal:"center"}}},
            {v: csu, s:{alignment:{horizontal:"center"}}}
        ]);
    });
    
    // Section Total
    estData.push([
        {v:"Section Total", s:{font:{bold:true}, fill:{fgColor:{rgb:"E7E6E6"}}, alignment:{horizontal:"right"}}},
        {v:"", s:{fill:{fgColor:{rgb:"E7E6E6"}}}},
        {v:"", s:{fill:{fgColor:{rgb:"E7E6E6"}}}},
        {v:"", s:{fill:{fgColor:{rgb:"E7E6E6"}}}},
        {v:"", s:{fill:{fgColor:{rgb:"E7E6E6"}}}},
        {v:sectionTotal.toFixed(1), s:{font:{bold:true}, fill:{fgColor:{rgb:"E7E6E6"}}, alignment:{horizontal:"center"}}},
        {v:sectionCSU.toFixed(1), s:{font:{bold:true}, fill:{fgColor:{rgb:"E7E6E6"}}, alignment:{horizontal:"center"}}}
    ]);
    estData.push([]);
    
    grandTotalHours += sectionTotal;
    grandTotalCSUHours += sectionCSU;
    
    // Grand Total
    estData.push([
        {v:"GRAND TOTAL", s:{font:{bold:true, sz:12, color:{rgb:"FFFFFF"}}, fill:{fgColor:{rgb:"595959"}}, alignment:{horizontal:"right"}}},
        {v:"", s:{fill:{fgColor:{rgb:"595959"}}}},
        {v:"", s:{fill:{fgColor:{rgb:"595959"}}}},
        {v:"", s:{fill:{fgColor:{rgb:"595959"}}}},
        {v:"", s:{fill:{fgColor:{rgb:"595959"}}}},
        {v:grandTotalHours.toFixed(1), s:{font:{bold:true, sz:12, color:{rgb:"FFFFFF"}}, fill:{fgColor:{rgb:"595959"}}, alignment:{horizontal:"center"}}},
        {v:grandTotalCSUHours.toFixed(1), s:{font:{bold:true, sz:12, color:{rgb:"FFFFFF"}}, fill:{fgColor:{rgb:"595959"}}, alignment:{horizontal:"center"}}}
    ]);
    
    const wsEst = XLSX.utils.aoa_to_sheet(estData);
    wsEst['!cols'] = [
        {wch:35}, {wch:60}, {wch:12}, {wch:12}, {wch:8}, {wch:15}, {wch:12}
    ];
    XLSX.utils.book_append_sheet(wb, wsEst, "Estimation");
    
    // Save workbook
    XLSX.writeFile(wb, `${customerName}_Redwood_Estimation.xlsx`);
}

// ============================================
// JSON CONFIG EXPORT/IMPORT
// ============================================
function downloadJSON() {
    const customerName = document.getElementById('customerName').value || 'Customer';
    const jsonData = {
        version: '1.0',
        exportDate: new Date().toISOString(),
        customerName: customerName,
        selectedModules: Array.from(selectedModules),
        personalizationCounts: personalizationCounts,
        config: CONFIG
    };
    const jsonString = JSON.stringify(jsonData, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${customerName}_Redwood_Config.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function uploadJSON() {
    const file = document.getElementById('jsonFile').files[0];
    if (!file) { 
        alert('Please select a JSON file first'); 
        return; 
    }
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const jsonData = JSON.parse(e.target.result);
            if (!jsonData.config || !jsonData.selectedModules) {
                throw new Error('Invalid JSON structure');
            }
            document.getElementById('customerName').value = jsonData.customerName || 'Customer';
            selectedModules.clear();
            jsonData.selectedModules.forEach(mod => selectedModules.add(mod));
            personalizationCounts = Object.assign({}, jsonData.personalizationCounts || {});
            CONFIG.overview = JSON.parse(JSON.stringify(jsonData.config.overview));
            CONFIG.products = JSON.parse(JSON.stringify(jsonData.config.products));
            CONFIG.hypercare = JSON.parse(JSON.stringify(jsonData.config.hypercare));
            renderSelector();
            renderEstimation();
            if(currentUser === 'admin') renderAdmin();
            alert('âœ“ JSON configuration imported successfully!');
            document.getElementById('jsonFile').value = '';
        } catch(err) {
            alert('Error reading JSON file: ' + err.message);
        }
    };
    reader.readAsText(file);
}

// Initialize on load
window.addEventListener('DOMContentLoaded', function() {
    console.log('Redwood Estimator loaded');
});
</script>
</body>
</html>
