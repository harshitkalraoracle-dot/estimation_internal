<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redwood Adoption Estimator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
    </style>
</head>
<body>
<div id="app" class="min-h-screen p-6 md:p-10">
    <div class="max-w-7xl mx-auto bg-white shadow-xl rounded-xl overflow-hidden">

        <!-- Header -->
        <div class="bg-indigo-900 text-white p-6 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold">Redwood Adoption Estimator</h1>
                <p class="text-indigo-200 text-sm mt-1">SCM Redwood UI Adoption – Effort & CSU Calculator</p>
            </div>
            <button @click="generateExcel" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2.5 px-5 rounded-lg shadow flex items-center gap-2 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                Download Excel
            </button>
        </div>

        <div class="p-8">

            <!-- Project Info -->
            <div class="mb-12 bg-gray-50 p-6 rounded-xl border border-gray-200">
                <h2 class="text-lg font-bold mb-4 text-gray-800">Project Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2">Customer Name</label>
                        <input v-model="customerName" type="text" class="border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-lg w-full py-2.5 px-4 shadow-sm" placeholder="e.g. Acme Corp">
                    </div>
                </div>
            </div>

            <!-- Products -->
            <h2 class="text-xl font-bold mb-6 text-gray-800">Products & Modules</h2>

            <div v-for="(product, pIdx) in products" :key="pIdx" class="mb-10 border border-gray-300 rounded-xl p-6 bg-white shadow">
                <!-- Product header -->
                <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-200">
                    <div class="flex items-center gap-4">
                        <select v-model="product.name" @change="onProductChange(pIdx)" class="text-lg font-semibold bg-indigo-50 border border-indigo-300 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-indigo-400 min-w-[300px]">
                            <option v-for="p in productsList" :value="p.name">{{ p.name }} ({{ p.weight }}×)</option>
                        </select>
                        <div class="bg-indigo-100 text-indigo-800 px-4 py-2 rounded font-medium">
                            Weight: {{ getProductWeight(product.name) }}×
                        </div>
                    </div>
                    <button @click="removeProduct(pIdx)" class="text-red-600 hover:text-red-800 font-medium">Remove Product</button>
                </div>

                <div class="space-y-5">
                    <div v-for="(mod, mIdx) in product.modules" :key="mIdx" class="flex flex-wrap md:flex-nowrap gap-5 items-end bg-gray-50 p-5 rounded-lg border border-gray-200">
                        <div class="flex-1 min-w-[240px]">
                            <label class="block text-xs font-semibold text-gray-600 uppercase mb-2">Module Name</label>
                            <input list="modules" v-model="mod.name" type="text" placeholder="Type or select module" class="w-full border-gray-300 rounded-lg py-2.5 px-4 focus:border-indigo-500 focus:ring-indigo-400">
                            <datalist id="modules">
                                <option v-for="m in getModulesForProduct(product.name)" :value="m.name"></option>
                            </datalist>
                        </div>
                        <div class="w-32">
                            <label class="block text-xs font-semibold text-gray-600 uppercase mb-2">Features</label>
                            <input v-model.number="mod.features" type="number" min="0" class="w-full text-center border-gray-300 rounded-lg py-2.5 focus:border-indigo-500">
                        </div>
                        <div class="w-32">
                            <label class="block text-xs font-semibold text-gray-600 uppercase mb-2">Personalizations</label>
                            <input v-model.number="mod.personalizations" type="number" min="0" class="w-full text-center border-gray-300 rounded-lg py-2.5 focus:border-indigo-500">
                        </div>
                        <button @click="removeModule(pIdx, mIdx)" class="text-red-500 hover:text-red-700 text-3xl font-bold pb-2">×</button>
                    </div>
                </div>

                <button @click="addModule(pIdx)" class="mt-6 text-indigo-700 hover:text-indigo-900 font-semibold flex items-center gap-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/></svg>
                    Add Module
                </button>

                <div class="mt-8 p-5 bg-gradient-to-r from-indigo-50 to-emerald-50 rounded-lg border flex justify-between items-center">
                    <div class="flex gap-12">
                        <div>
                            <div class="text-sm text-gray-600 uppercase font-semibold tracking-wide">Features</div>
                            <div class="text-3xl font-bold text-indigo-700">{{ getProductFeatures(product) }}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-600 uppercase font-semibold tracking-wide">Personalizations</div>
                            <div class="text-3xl font-bold text-emerald-700">{{ getProductPersonalizations(product) }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <button @click="addProduct" class="w-full py-5 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg flex items-center justify-center gap-3 transition transform hover:scale-[1.02] mb-12">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                Add New Product
            </button>

            <!-- Summary Panel -->
            <div class="bg-gradient-to-br from-gray-800 to-gray-950 text-white p-10 rounded-2xl shadow-2xl">
                <h3 class="text-2xl font-bold mb-8 flex items-center gap-4">
                    <svg class="w-8 h-8 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    Final Estimation Summary
                </h3>
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-8">
                    <div class="bg-white/10 backdrop-blur-md p-6 rounded-xl">
                        <div class="text-gray-300 text-sm uppercase font-semibold tracking-wider">Total Features</div>
                        <div class="text-5xl font-extrabold mt-2 text-blue-300">{{ grandTotals.features }}</div>
                    </div>
                    <div class="bg-white/10 backdrop-blur-md p-6 rounded-xl">
                        <div class="text-gray-300 text-sm uppercase font-semibold tracking-wider">Total Personalizations</div>
                        <div class="text-5xl font-extrabold mt-2 text-emerald-300">{{ grandTotals.personalizations }}</div>
                    </div>
                    <div class="bg-white/10 backdrop-blur-md p-6 rounded-xl">
                        <div class="text-gray-300 text-sm uppercase font-semibold tracking-wider">Estimated CSUs</div>
                        <div class="text-5xl font-extrabold mt-2 text-yellow-300">{{ grandTotals.csu }}</div>
                    </div>
                    <div class="bg-white/10 backdrop-blur-md p-6 rounded-xl">
                        <div class="text-gray-300 text-sm uppercase font-semibold tracking-wider">Products</div>
                        <div class="text-5xl font-extrabold mt-2 text-purple-300">{{ products.length }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const { createApp } = Vue;

const PRODUCTS = [ /* your full PRODUCTS array here */ ];
const MODULES  = [ /* your full MODULES array here */ ];

const FIXED = {
    discussion: 8, documentation: 16, demo: 8,
    unitTestMain: 40, classicCompare: 24, uatAssist: 24,
    migrationPerPers: 0.2,
    hypercareBase: 32, hypercareFactor: 0.25
};

const STYLES = {
    title:       { fill: { fgColor: { rgb: "9BC2E6" } }, font: { bold: true, sz: 16, color: { rgb: "000000" } }, alignment: { horizontal: "center", vertical: "center" } },
    header:      { fill: { fgColor: { rgb: "DDEBF7" } }, font: { bold: true, sz: 12 }, alignment: { horizontal: "center", vertical: "center" } },
    section:     { fill: { fgColor: { rgb: "A5A5A5" } }, font: { bold: true, color: { rgb: "FFFFFF" } }, alignment: { horizontal: "center" } },
    totalGreen:  { fill: { fgColor: { rgb: "C6E0B4" } }, font: { bold: true }, alignment: { horizontal: "center" } },
    grandTotal:  { fill: { fgColor: { rgb: "595959" } }, font: { bold: true, color: { rgb: "FFFFFF" }, sz: 13 }, alignment: { horizontal: "center" } },
    regular:     { alignment: { vertical: "center" }, border: { top: {style:"thin"}, bottom: {style:"thin"}, left: {style:"thin"}, right: {style:"thin"} } }
};

createApp({
    data() {
        return {
            customerName: "Example Corp",
            productsList: PRODUCTS,
            modulesList: MODULES,
            products: [{ name: PRODUCTS[0]?.name || "Procurement", modules: [] }]
        };
    },
    computed: {
        grandTotals() {
            let f=0, p=0, c=0;
            this.products.forEach(prod => {
                const feats = prod.modules.reduce((s,m)=>s+(m.features||0),0);
                const pers = prod.modules.reduce((s,m)=>s+(m.personalizations||0),0);
                f += feats; p += pers;
                const w = this.getProductWeight(prod.name);
                c += feats*0.25 + feats*10*w + pers*2;
            });
            c += FIXED.discussion + FIXED.documentation + FIXED.demo +
                 FIXED.unitTestMain + FIXED.classicCompare + FIXED.uatAssist +
                 p * FIXED.migrationPerPers +
                 Math.max(FIXED.hypercareBase, p * FIXED.hypercareFactor);
            return { features: f, personalizations: p, csu: Math.round(c) };
        }
    },
    methods: {
        getProductWeight(n) { return PRODUCTS.find(p=>p.name===n)?.weight ?? 1; },
        getModulesForProduct(n) { return MODULES.filter(m=>m.product===n); },
        getProductFeatures(p) { return p.modules.reduce((s,m)=>s+(m.features||0),0); },
        getProductPersonalizations(p) { return p.modules.reduce((s,m)=>s+(m.personalizations||0),0); },

        onProductChange(i) { this.products[i].modules = []; },
        addProduct() { this.products.push({ name: PRODUCTS[0].name, modules: [] }); },
        removeProduct(i) { if(this.products.length>1) this.products.splice(i,1); },
        addModule(i) { this.products[i].modules.push({name:"", features:0, personalizations:0}); },
        removeModule(p,i) { this.products[p].modules.splice(i,1); },

        applyStyle(ws, range, styleObj) {
            const rangeObj = typeof range === 'string' ? XLSX.utils.decode_range(range) : range;
            for (let R = rangeObj.s.r; R <= rangeObj.e.r; ++R) {
                for (let C = rangeObj.s.c; C <= rangeObj.e.c; ++C) {
                    const addr = XLSX.utils.encode_cell({r:R, c:C});
                    if (!ws[addr]) ws[addr] = {};
                    ws[addr].s = { ...styleObj };
                }
            }
        },

        generateExcel() {
            const wb = XLSX.utils.book_new();
            const totalPers = this.grandTotals.personalizations;

            this.products.forEach((prod, idx) => {
                const isFirst = idx === 0;
                const feats = this.getProductFeatures(prod);
                const pers  = this.getProductPersonalizations(prod);
                const w     = this.getProductWeight(prod.name);

                const data = [];
                let row = 0;

                data[row++] = [`REDWOOD ADOPTION ESTIMATION - ${prod.name.toUpperCase()}`];
                data[row++] = [];
                data[row++] = [];
                data[row++] = ["Customer", this.customerName, "", "", "Features", feats];
                data[row++] = ["Date", new Date().toLocaleDateString(), "", "", "Personalizations", pers];
                data[row++] = [];
                data[row++] = [];

                const addSection = (title, activities) => {
                    data[row++] = [title];
                    data[row++] = [];
                    data[row++] = ["Activity", "Detailed Activity", "Non-Prod", "Prod", "Qty", "Total Hours", "CSUs"];
                    const start = row;

                    activities.forEach(act => {
                        const totalH = (act.nonProd + act.prod) * act.qty;
                        data[row++] = [act.name, act.desc, act.nonProd, act.prod, act.qty, totalH, totalH/2];
                    });

                    const secTotal = activities.reduce((s,a)=>s+(a.nonProd+a.prod)*a.qty,0);
                    data[row++] = ["Section Total","","","","",secTotal,secTotal/2];
                    data[row++] = [];
                    data[row++] = [];
                };

                if (isFirst) {
                    addSection("1. ASSESSMENT ACTIVITIES", [
                        {name:"Discussion", desc:"Introduction of Redwood Features + roadmap + asset inventory + workplan review", nonProd:8, prod:0, qty:1},
                        {name:"Documentation", desc:"CWB's, Adoption Document, Workplan", nonProd:16, prod:0, qty:1},
                        {name:"Demo/Review", desc:"Walk-through before/after + sample transactions", nonProd:8, prod:0, qty:1}
                    ]);

                    addSection("3. UNIT TESTING & UAT ASSISTANCE", [
                        {name:"Unit Testing", desc:"Detailed column-by-column comparison", nonProd:40, prod:0, qty:1},
                        {name:"Classic vs Redwood Comparison", desc:"Ensure no field/functionality missed", nonProd:24, prod:0, qty:1},
                        {name:"Assist in UAT", desc:"Resolve Redwood issues during testing", nonProd:24, prod:0, qty:1}
                    ]);
                }

                addSection(`2. ADOPTION ACTIVITIES – ${prod.name}`, [
                    {name:"Feature Enablement", desc:"Setup, Profile, Opt-in per feature", nonProd:0.15, prod:0.1, qty:feats},
                    {name:"Verification at Config Level", desc:"Check all features enabled", nonProd:0.1, prod:0.1, qty:feats},
                    {name:"UI Verification & Comparison", desc:`Classic vs Redwood UI (weight ${w}×)`, nonProd:8*w, prod:8*w, qty:1},
                    {name:"Personalization Conversion", desc:"Redo personalizations due to architecture change", nonProd:2, prod:0.5, qty:pers},
                    {name:"Additional Personalization", desc:"Expected during customer testing", nonProd:2, prod:0, qty:Math.max(1, Math.floor(pers*0.1))}
                ]);

                if (isFirst) {
                    addSection("4. MIGRATION ACTIVITIES", [
                        {name:"Non-Prod Deployment", desc:"Deploy personalizations to selected non-prod env", nonProd:0.2, prod:0.1, qty:totalPers},
                        {name:"Production Deployment", desc:"UI + setups + personalizations signed-off", nonProd:0, prod:1, qty:totalPers}
                    ]);

                    addSection("5. POST-GO-LIVE HYPERCARE", [
                        {name:"Hypercare Support", desc:"3 weeks full support for issues", nonProd:0, prod:4, qty:Math.max(8, Math.floor(totalPers*0.2))}
                    ]);
                }

                data[row++] = [];
                data[row++] = ["GRAND TOTAL","","","","", {f:`=SUM(F8:F${row})`}, {f:`=SUM(G8:G${row})`}];

                const ws = XLSX.utils.aoa_to_sheet(data);
                ws['!merges'] = [{s:{r:0,c:0},e:{r:0,c:6}}];

                // Apply colors
                this.applyStyle(ws, "A1:G1", STYLES.title);
                this.applyStyle(ws, "A3:G3", STYLES.header);
                this.applyStyle(ws, "A4:G4", STYLES.header);
                this.applyStyle(ws, "A8:G8", STYLES.header); // first table header

                // Section totals green
                let current = 9;
                if (isFirst) current += 12; // rough skip for assessment + unit testing
                this.applyStyle(ws, `A${current}:G${current}`, STYLES.totalGreen);
                current += 8; // next section
                this.applyStyle(ws, `A${current}:G${current}`, STYLES.totalGreen);

                // Grand total dark
                this.applyStyle(ws, `A${row}:G${row}`, STYLES.grandTotal);

                // Borders everywhere
                for (let r=0; r<row; r++) {
                    for (let c=0; c<7; c++) {
                        const addr = XLSX.utils.encode_cell({r, c});
                        if (ws[addr] && !ws[addr].s?.border) {
                            if (!ws[addr].s) ws[addr].s = {};
                            ws[addr].s.border = STYLES.regular.border;
                        }
                    }
                }

                ws['!cols'] = [
                    {wch: 38}, {wch: 75}, {wch: 14}, {wch: 14}, {wch: 10}, {wch: 16}, {wch: 14}
                ];

                XLSX.utils.book_append_sheet(wb, ws, prod.name.slice(0,31));
            });

            XLSX.writeFile(wb, `Redwood_Adoption_Estimation_${(this.customerName||'Project').replace(/[^a-z0-9]/gi,'_')}.xlsx`);
        }
    }
}).mount('#app');
</script>
</body>
</html>
