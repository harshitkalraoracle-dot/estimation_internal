<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redwood Adoption Estimator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #2d3748;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            color: #718096;
            font-size: 16px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .upload-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .upload-card h2 {
            color: #2d3748;
            font-size: 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .upload-icon {
            font-size: 24px;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
            margin-bottom: 15px;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: block;
            padding: 15px 20px;
            background: #667eea;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            font-weight: 600;
        }

        .file-input-label:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .file-name {
            padding: 10px;
            background: #f7fafc;
            border-radius: 6px;
            color: #4a5568;
            font-size: 14px;
            margin-top: 10px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-section {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
        }

        .preview-section table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .preview-section th {
            background: #667eea;
            color: white;
            padding: 8px;
            text-align: left;
            position: sticky;
            top: 0;
        }

        .preview-section td {
            padding: 8px;
            border-bottom: 1px solid #e2e8f0;
        }

        .preview-section tr:hover {
            background: #edf2f7;
        }

        .config-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }

        .config-section h2 {
            color: #2d3748;
            font-size: 20px;
            margin-bottom: 20px;
        }

        .customer-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .customer-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 8px;
            color: white;
            text-align: center;
        }

        .summary-card h3 {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .summary-card .value {
            font-size: 32px;
            font-weight: bold;
        }

        .generate-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .generate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(72, 187, 120, 0.4);
        }

        .generate-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }

        .status-message {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
            display: none;
        }

        .status-message.success {
            background: #c6f6d5;
            color: #22543d;
            display: block;
        }

        .status-message.error {
            background: #fed7d7;
            color: #742a2a;
            display: block;
        }

        .status-message.info {
            background: #bee3f8;
            color: #2c5282;
            display: block;
        }

        .instructions {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }

        .instructions h3 {
            color: #2d3748;
            margin-bottom: 10px;
        }

        .instructions ul {
            color: #4a5568;
            padding-left: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .loading-spinner {
            display: none;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Redwood Adoption Estimator</h1>
            <p>Upload your feature list and personalization data to generate a comprehensive estimation</p>
        </div>

        <div class="instructions">
            <h3>üìã Instructions</h3>
            <ul>
                <li><strong>Feature Excel:</strong> Upload an Excel file with columns: Product, Module, Features (or S.no, Product, Module, Feature)</li>
                <li><strong>Personalization Excel:</strong> Upload an Excel file with columns: Product, Personalizations (or Product Group, Product, Personalizations)</li>
                <li>Enter your customer name</li>
                <li>Click "Generate Estimation" to download your customized workbook</li>
            </ul>
        </div>

        <div class="config-section">
            <h2>üë§ Customer Information</h2>
            <input type="text" 
                   id="customerName" 
                   class="customer-input" 
                   placeholder="Enter customer name (e.g., Acme Corporation)"
                   value="Global Enterprises">
        </div>

        <div class="main-content">
            <div class="upload-card">
                <h2><span class="upload-icon">üìä</span> Feature List</h2>
                <div class="file-input-wrapper">
                    <input type="file" id="featureFile" accept=".xlsx,.xls,.csv" onchange="handleFeatureUpload(event)">
                    <label for="featureFile" class="file-input-label">
                        Choose Feature Excel File
                    </label>
                </div>
                <div id="featureFileName" class="file-name">No file selected</div>
                <div id="featurePreview" class="preview-section" style="display:none;"></div>
            </div>

            <div class="upload-card">
                <h2><span class="upload-icon">üé®</span> Personalization Data</h2>
                <div class="file-input-wrapper">
                    <input type="file" id="persFile" accept=".xlsx,.xls,.csv" onchange="handlePersUpload(event)">
                    <label for="persFile" class="file-input-label">
                        Choose Personalization Excel File
                    </label>
                </div>
                <div id="persFileName" class="file-name">No file selected</div>
                <div id="persPreview" class="preview-section" style="display:none;"></div>
            </div>
        </div>

        <div class="config-section">
            <h2>üìà Configuration Summary</h2>
            <div class="summary-cards">
                <div class="summary-card">
                    <h3>Products</h3>
                    <div class="value" id="productCount">0</div>
                </div>
                <div class="summary-card">
                    <h3>Total Features</h3>
                    <div class="value" id="featureCount">0</div>
                </div>
                <div class="summary-card">
                    <h3>Total Personalizations</h3>
                    <div class="value" id="persCount">0</div>
                </div>
                <div class="summary-card">
                    <h3>Estimated CSU</h3>
                    <div class="value" id="estimatedCSU">0</div>
                </div>
            </div>

            <button id="generateBtn" class="generate-btn" onclick="generateEstimation()" disabled>
                Generate Estimation Workbook
            </button>

            <div class="loading-spinner" id="loadingSpinner"></div>
            <div id="statusMessage" class="status-message"></div>
        </div>
    </div>

    <script>
        let featureData = null;
        let personalizationData = null;
        let productConfig = {};

        // Product weights for complexity-based estimation
        const PRODUCT_WEIGHTS = {
            "SCM Common Components": 0.5,
            "Inventory Management": 1.2,
            "Maintenance": 1.2,
            "Manufacturing": 1.5,
            "Order Management": 1.0,
            "Collaboration Messaging Framework": 1.0,
            "Procurement": 1.0,
            "Product Hub": 1.0,
            "Purchasing": 1.0,
            "Quality Management": 1.1,
            "Self Service Procurement & RSSP": 1.0,
            "Supply Chain Collaboration": 1.0,
            "Supply Chain Orchestration": 1.1,
            "Supply Chain Planning": 1.2
        };

        function getProductWeight(productName) {
            return PRODUCT_WEIGHTS[productName] || 1.0;
        }

        function handleFeatureUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('featureFileName').textContent = `üìÑ ${file.name}`;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    featureData = processFeatureData(jsonData);
                    displayFeaturePreview(jsonData.slice(0, 10));
                    updateConfiguration();
                    
                    showStatus('Feature file loaded successfully!', 'success');
                } catch (error) {
                    showStatus('Error reading feature file: ' + error.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function handlePersUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('persFileName').textContent = `üìÑ ${file.name}`;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    personalizationData = processPersonalizationData(jsonData);
                    displayPersPreview(jsonData.slice(0, 10));
                    updateConfiguration();
                    
                    showStatus('Personalization file loaded successfully!', 'success');
                } catch (error) {
                    showStatus('Error reading personalization file: ' + error.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function processFeatureData(data) {
            const productModuleData = {};
            
            data.forEach(row => {
                // Try different column name variations
                const product = row.Product || row.product || row.PRODUCT;
                const module = row.Module || row.module || row.MODULE;
                const feature = row.Feature || row.feature || row.FEATURE || row.Features;
                
                if (product) {
                    if (!productModuleData[product]) {
                        productModuleData[product] = {};
                    }
                    
                    // If module is specified, count features per module
                    if (module) {
                        if (!productModuleData[product][module]) {
                            productModuleData[product][module] = 0;
                        }
                        productModuleData[product][module] += 1;
                    } else {
                        // If no module, use product name as module
                        if (!productModuleData[product][product]) {
                            productModuleData[product][product] = 0;
                        }
                        productModuleData[product][product] += 1;
                    }
                }
            });

            return productModuleData;
        }

        function processPersonalizationData(data) {
            const productModuleData = {};
            
            data.forEach(row => {
                // Try different column name variations
                const product = row.Product || row.product || row.PRODUCT;
                const module = row.Module || row.module || row.MODULE;
                const pers = row['Total Number of Personalizations'] || 
                           row['Total Personalizations'] || 
                           row.Personalizations || 
                           row.personalizations || 
                           row.PERSONALIZATIONS || 0;
                
                if (product) {
                    if (!productModuleData[product]) {
                        productModuleData[product] = {};
                    }
                    
                    // If module is specified, store by module
                    if (module && module !== product) {
                        productModuleData[product][module] = parseInt(pers) || 0;
                    } else {
                        // If no module, use product name as module
                        productModuleData[product][product] = parseInt(pers) || 0;
                    }
                }
            });

            return productModuleData;
        }

        function updateConfiguration() {
            if (!featureData || !personalizationData) return;

            productConfig = {};
            let totalFeatures = 0;
            let totalPers = 0;

            // Get all unique products from both datasets
            const allProducts = new Set([...Object.keys(featureData), ...Object.keys(personalizationData)]);
            
            // Build module-level configuration
            allProducts.forEach(product => {
                productConfig[product] = {};
                
                // Get all modules for this product from both sources
                const featureModules = featureData[product] || {};
                const persModules = personalizationData[product] || {};
                const allModules = new Set([...Object.keys(featureModules), ...Object.keys(persModules)]);
                
                // Combine data for each module
                allModules.forEach(module => {
                    const features = featureModules[module] || 0;
                    const pers = persModules[module] || 0;
                    
                    productConfig[product][module] = {
                        features: features,
                        personalizations: pers
                    };
                    
                    totalFeatures += features;
                    totalPers += pers;
                });
            });

            // Update summary cards
            document.getElementById('productCount').textContent = allProducts.size;
            document.getElementById('featureCount').textContent = totalFeatures;
            document.getElementById('persCount').textContent = totalPers;
            
            // More accurate CSU estimation using product weights
            let estimatedHours = 0;
            
            // First product gets overview, UAT, migration, hypercare
            let isFirst = true;
            allProducts.forEach(product => {
                const weight = getProductWeight(product);
                let productFeatures = 0;
                let productPers = 0;
                
                // Sum features and personalizations for this product
                Object.values(productConfig[product]).forEach(module => {
                    productFeatures += module.features;
                    productPers += module.personalizations;
                });
                
                if (isFirst) {
                    // Assessment: 32 hrs
                    estimatedHours += 32;
                    // UAT: 88 hrs
                    estimatedHours += 88;
                    // Migration: ~1.2 * total_pers
                    estimatedHours += totalPers * 1.2;
                    // Hypercare: 4 * max(8, totalPers * 0.2)
                    estimatedHours += 4 * Math.max(8, Math.ceil(totalPers * 0.2));
                    isFirst = false;
                }
                
                // Adoption activities for each product
                estimatedHours += productFeatures * 0.4; // Features enablement + verification
                estimatedHours += 16 * weight; // UI verification with weight
                estimatedHours += productPers * 2; // Personalization enablement
                if (productPers > 0) {
                    estimatedHours += productPers * 0.2; // Additional personalizations
                }
            });
            
            const estimatedCSU = Math.round(estimatedHours / 2);
            document.getElementById('estimatedCSU').textContent = estimatedCSU;

            // Enable generate button
            document.getElementById('generateBtn').disabled = false;
        }

        function displayFeaturePreview(data) {
            const preview = document.getElementById('featurePreview');
            preview.style.display = 'block';
            
            if (data.length === 0) {
                preview.innerHTML = '<p>No data to preview</p>';
                return;
            }

            const headers = Object.keys(data[0]);
            let html = '<table><thead><tr>';
            headers.forEach(h => html += `<th>${h}</th>`);
            html += '</tr></thead><tbody>';
            
            data.forEach(row => {
                html += '<tr>';
                headers.forEach(h => html += `<td>${row[h] || ''}</td>`);
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            preview.innerHTML = html;
        }

        function displayPersPreview(data) {
            const preview = document.getElementById('persPreview');
            preview.style.display = 'block';
            
            if (data.length === 0) {
                preview.innerHTML = '<p>No data to preview</p>';
                return;
            }

            const headers = Object.keys(data[0]);
            let html = '<table><thead><tr>';
            headers.forEach(h => html += `<th>${h}</th>`);
            html += '</tr></thead><tbody>';
            
            data.forEach(row => {
                html += '<tr>';
                headers.forEach(h => html += `<td>${row[h] || ''}</td>`);
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            preview.innerHTML = html;
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${type}`;
            
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        function generateEstimation() {
            const customerName = document.getElementById('customerName').value.trim() || 'Global Enterprises';
            
            if (Object.keys(productConfig).length === 0) {
                showStatus('Please upload both feature and personalization files first!', 'error');
                return;
            }

            // Show loading
            document.getElementById('loadingSpinner').style.display = 'block';
            showStatus('Generating your estimation workbook...', 'info');

            // Generate Python code
            const pythonCode = generatePythonCode(customerName, productConfig);
            
            // Show the code to user
            setTimeout(() => {
                document.getElementById('loadingSpinner').style.display = 'none';
                showGeneratedCode(pythonCode, customerName, productConfig);
            }, 1000);
        }

        function generatePythonCode(customerName, config) {
            let code = `from redwood_module_estimator_FIXED import RedwoodEstimatorGenerator\n\n`;
            code += `# Create estimator\n`;
            code += `estimator = RedwoodEstimatorGenerator()\n`;
            code += `estimator.set_customer_name("${customerName}")\n\n`;
            code += `# Module-level configuration from uploaded files\n`;
            code += `config = {\n`;
            
            const products = Object.keys(config);
            products.forEach((product, prodIndex) => {
                code += `    "${product}": {\n`;
                
                const modules = Object.keys(config[product]);
                modules.forEach((module, modIndex) => {
                    const data = config[product][module];
                    code += `        "${module}": {"features": ${data.features}, "personalizations": ${data.personalizations}}`;
                    if (modIndex < modules.length - 1) {
                        code += ',';
                    }
                    code += '\n';
                });
                
                code += `    }`;
                if (prodIndex < products.length - 1) {
                    code += ',';
                }
                code += '\n';
            });
            
            code += `}\n\n`;
            code += `estimator.load_from_config(config)\n`;
            code += `estimator.generate_workbook("${customerName.replace(/[^a-zA-Z0-9]/g, '_')}_Redwood_Estimation.xlsx")\n`;
            
            return code;
        }

        function showGeneratedCode(code, customerName, config) {
            // Calculate totals for display
            let totalFeatures = 0;
            let totalPers = 0;
            let moduleBreakdown = '';
            
            Object.entries(config).forEach(([product, modules]) => {
                moduleBreakdown += `<div style="margin-bottom: 15px;">
                    <strong>${product}:</strong><br>`;
                
                Object.entries(modules).forEach(([module, data]) => {
                    totalFeatures += data.features;
                    totalPers += data.personalizations;
                    moduleBreakdown += `<span style="margin-left: 20px;">‚Üí ${module}: ${data.features} features, ${data.personalizations} personalizations</span><br>`;
                });
                
                moduleBreakdown += `</div>`;
            });
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
                padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 12px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto;">
                    <h2 style="margin-bottom: 20px; color: #2d3748;">‚úÖ Configuration Generated Successfully!</h2>
                    
                    <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #2d3748; margin-bottom: 15px;">üìä Summary</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                            <div>
                                <strong>Customer:</strong> ${customerName}<br>
                                <strong>Products:</strong> ${Object.keys(config).length}
                            </div>
                            <div>
                                <strong>Total Features:</strong> ${totalFeatures}<br>
                                <strong>Total Personalizations:</strong> ${totalPers}
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 6px; max-height: 200px; overflow-y: auto;">
                            <strong>Module Breakdown:</strong><br><br>
                            ${moduleBreakdown}
                        </div>
                    </div>

                    <h3 style="color: #2d3748; margin-bottom: 10px;">üêç Python Code</h3>
                    <p style="color: #718096; margin-bottom: 15px;">Copy and run this code to generate your estimation:</p>
                    
                    <div style="background: #2d3748; color: #e2e8f0; padding: 20px; border-radius: 8px; margin-bottom: 20px; overflow-x: auto; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6; max-height: 300px; overflow-y: auto;">
                        <pre style="margin: 0;">${code}</pre>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button onclick="copyCode('${btoa(code)}')" style="flex: 1; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            üìã Copy Code
                        </button>
                        <button onclick="downloadConfig('${btoa(JSON.stringify({customerName, config}))}')" style="flex: 1; padding: 12px; background: #48bb78; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            üíæ Download Config
                        </button>
                        <button onclick="closeModal()" style="flex: 1; padding: 12px; background: #cbd5e0; color: #2d3748; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            ‚úñÔ∏è Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentModal = modal;
        }

        function copyCode(encodedCode) {
            const code = atob(encodedCode);
            navigator.clipboard.writeText(code).then(() => {
                showStatus('Code copied to clipboard!', 'success');
            });
        }

        function downloadConfig(encodedConfig) {
            const configData = JSON.parse(atob(encodedConfig));
            const code = generatePythonCode(configData.customerName, configData.config);
            
            const blob = new Blob([code], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${configData.customerName.replace(/[^a-zA-Z0-9]/g, '_')}_estimation_script.py`;
            a.click();
            URL.revokeObjectURL(url);
            
            showStatus('Python script downloaded!', 'success');
        }

        function closeModal() {
            if (window.currentModal) {
                window.currentModal.remove();
            }
        }
    </script>
</body>
</html>
